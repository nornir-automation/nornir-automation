<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="This is a guest post by Denis Mulyalin, follow github account and twitter feed for latest updates.
 Network testing overview For the start lets introduce some terminology and structure. Network Testing could be roughly defined as a process of making sure that your network is adhere to a certain level of quality. Network tests itself could be classified based on a variety of properties. For example using test scope as a test metric allows us to sort tests across these categories:" />
<meta name="keywords" content="nornir automation networking programming python golang, nornir, guest, testing, network testing" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="/2021/08/06/testing-your-network-with-nornir-testsprocessor/" />


    <title>
        
            Testing your network with Nornir TestsProcessor :: nornir.tech  — News and information about nornir&#39;s projects
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.dede02da9537a98158079c023e83573e18127834838ef08172acce888341a797.css">


    
        <link rel="stylesheet" type="text/css" href="/css/callout.css">
    

    
        <link rel="stylesheet" type="text/css" href="/css/menu.css">
    





<meta itemprop="name" content="Testing your network with Nornir TestsProcessor">
<meta itemprop="description" content="This is a guest post by Denis Mulyalin, follow github account and twitter feed for latest updates.
 Network testing overview For the start lets introduce some terminology and structure. Network Testing could be roughly defined as a process of making sure that your network is adhere to a certain level of quality. Network tests itself could be classified based on a variety of properties. For example using test scope as a test metric allows us to sort tests across these categories:">
<meta itemprop="datePublished" content="2021-08-06T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-08-06T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="3231">
<meta itemprop="image" content="/"/>



<meta itemprop="keywords" content="nornir,guest,testing,network testing," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/"/>

<meta name="twitter:title" content="Testing your network with Nornir TestsProcessor"/>
<meta name="twitter:description" content="This is a guest post by Denis Mulyalin, follow github account and twitter feed for latest updates.
 Network testing overview For the start lets introduce some terminology and structure. Network Testing could be roughly defined as a process of making sure that your network is adhere to a certain level of quality. Network tests itself could be classified based on a variety of properties. For example using test scope as a test metric allows us to sort tests across these categories:"/>







    <meta property="article:published_time" content="2021-08-06 00:00:00 &#43;0000 UTC" />








    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">nornir.tech</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner">
          <li>
            <div class="dropdown">
              <button class="dropbtn">projects
                <i class="fa fa-caret-down"></i>
              </button>
              <div class="dropdown-content">
                
                <a href="/nornir/">nornir</a>
                
                <a href="/gornir/">gornir</a>
                
                <a href="/tags/external-projects/">third party</a>
                
              </div>
            </div>
          </li>
          
            <li><a href="/posts/">news</a></li>
          
            <li><a href="/support/">support</a></li>
          
            <li><a href="/sponsors/">sponsors</a></li>
          
            <li><a href="/tags/">tags</a></li>
          
    </ul>

</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>16 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title">
                <a href="/2021/08/06/testing-your-network-with-nornir-testsprocessor/">Testing your network with Nornir TestsProcessor</a>
            </h1>

            

            <div class="post-content">
                <p><em>This is a guest post by Denis Mulyalin, follow <a href="https://github.com/dmulyalin">github account</a> and <a href="https://twitter.com/DMulyalin">twitter feed</a> for latest updates.</em></p>
<hr>
<h1 id="network-testing-overview">Network testing overview</h1>
<p>For the start lets introduce some terminology and structure. <strong>Network Testing</strong>
could be roughly defined as a process of making sure that your network is adhere
to a certain level of quality. Network tests itself could be classified based on
a variety of properties. For example using <strong>test scope</strong> as a test metric allows
us to sort tests across these categories:</p>
<ul>
<li>local (unit) - verify functionality and features contained within device itself
e.g. platform state, software version, configuration</li>
<li>adjacent (integration) - verify operation between device pairs e.g. various
protocols peerings, links, point to point connectivity</li>
<li>network (system) - verify network function end to end e.g. end-to-end
connectivity and performance verification</li>
</ul>
<p>Another criteria which is not the very apparent but quiet important from automation
perspectives is <strong>test complexity</strong> which identifies how difficult is it to automate
it. Using complexity we can separate tests across these sets:</p>
<ul>
<li>low complexity - easy to automate e.g. check that show command output contains
particular pattern</li>
<li>moderate complexity - requires correlation and testing of several criteria e.g.
verify that all active ISIS enabled interfaces have certain MTU</li>
<li>high complexity - usually this type of tests represent a collection of sub tests
spread across time and domains e.g. verify customer service provisioning</li>
</ul>
<p>In author&rsquo;s experience, about 70% of networking tests fall in the <em>low complexity</em>
category, 20% of tests are of <em>moderate complexity</em> and <em>high complexity</em> tests account
for around 9% of cases, 1% remaining probably cases that cannot be automated at all.
These numbers of course can differ from environment to environment and only serve
demonstration purposes to give us an idea of what are we dealing with.</p>
<h1 id="network-testing-tools-landscape">Network Testing tools landscape</h1>
<p>If majority of tests are of low complexity to automate, why not we all already
running automated tests suits on a constant basis?</p>
<p>Probably complexity itself is the answer here, complexity is a very subjective
criteria, it defines the entry barrier and if it too big, people just skip it
falling back to traditional methods.</p>
<p>Nonetheless, some network testing frameworks/tools that Author aware of are:</p>
<ul>
<li>PyATS - Ecosystem of libraries and tools to set up and run automated network tests</li>
<li>Napalm Validate - NAPALM built-in function to validate getters output</li>
<li>Batfish - Network Configuration Analysis tool</li>
</ul>
<p>List is not exhaustive, quiet sure other open source or free tools exist that Author
did not came across yet.</p>
<p>Another framework that we ca use for testing in general and network testing in
particular is - <em>Python Programming Language</em>.</p>
<p>We can either use Python itself or testing libraries that are part of Python ecosystem
such as <a href="https://docs.pytest.org/">pytest</a> or <a href="https://robotframework.org/">robot</a>.</p>
<p>For instance, if we decide to use Pytest we can write something like:</p>
<pre><code>from nornir import InitNornir
from nornir_netmiko import netmiko_send_command

nr = InitNornir(config_file=&quot;nornir_config.yaml&quot;)

def test_software_version():
    results = nr.run(
        task=netmiko_send_command,
        command_string=&quot;show version&quot;,
    )
    for host, result in results.items():
        assert &quot;16.10.1&quot; in result[0].result, &quot;{} software version is wrong&quot;.format(host)

def test_syslog_config():
    results = nr.run(
        task=netmiko_send_command,
        command_string=&quot;show run | inc logging&quot;,
    )
    for host, result in results.items():
        assert &quot;10.0.0.1&quot; in result[0].result, &quot;{} logging configuration is wrong&quot;.format(host)
</code></pre><p>Save above code in a file named <code>test_network_suite_v1.py</code> and provided that we have
Nornir, Netmiko and Pytest installed and configured we can run above tests:</p>
<pre><code>pytest test_network_suite_v1.py -vv
</code></pre><p>If all good we should get output similar to this:</p>
<pre><code>collected 2 items

test_network_suite_v1.py::test_software_version PASSED   [ 50%]
test_network_suite_v1.py::test_syslog_config PASSED      [100%]

============== 2 passed, 0 warnings in 4.35s ==================
</code></pre><p>What remaining is &ldquo;just&rdquo; to re-factor the code to account for individual devices,
make script to emit testing results in some pretty format and write another 10
or 100 test functions to have a satisfying test coverage.</p>
<p>Main benefit of that approach is that it gives the <em>ultimate flexibility</em> and
control - things you can test only limited by your knowledge of Python Programming
Language and its ecosystem of networking tools. It probably would be true to say
that you can test virtually anything using that approach.</p>
<p>Main drawback - learning curve or entry barrier. To gain the power of ultimate
flexibility one need to spend significant time and efforts to train itself.</p>
<p>Also, another drawback, we need to write code, potentially quiet a lot of code to
test even for something as simple as checking show commands output for pattern
containment.</p>
<p>Most of that code would end up redundant and could be organized in various functions
for better re-usability and DRY (don&rsquo;t repeat yourself) principles. But, as it
usually happens, that already was done and in this case distributed in a form of
Nornir <code>TestsProcessor</code> plugin within <a href="https://nornir-salt.readthedocs.io/">nornir-salt</a>
package.</p>
<h1 id="nornir-testsprocessor">Nornir TestsProcessor</h1>
<p>Nornir <a href="https://nornir.readthedocs.io/en/latest/tutorial/processors.html">processors</a>
are plugins that tap into task execution process to do various actions such as log
events, work with results or do other processing.</p>
<p>Nornir-salt is a package that contains Nornir plugins and functions including
<code>TestsProcessor</code>. Nornir-salt developed as part of SALTSTACK Nornir Proxy-Minion.
But, all plugins in Nornir-salt package designed to work with Nornir directly
and does not have any SALTSTACK dependencies.</p>
<p>Sample code to run tests using <code>TestsProcessor</code> - save to <code>test_network_suite_v2.py</code> file:</p>
<pre><code>from nornir import InitNornir
from nornir_salt import TestsProcessor, TabulateFormatter, netmiko_send_commands

nr = InitNornir(config_file=&quot;nornir_config.yaml&quot;)

# define your tests suite
tests_suite = [
    [&quot;show version&quot;, &quot;contains&quot;, &quot;17.3.1&quot;, &quot;Software version test&quot;],
    [&quot;show run | inc logging&quot;, &quot;contains&quot;, &quot;10.0.0.1&quot;, &quot;Logging configuration check&quot;],
    [&quot;show interfaces&quot;, &quot;!contains_lines&quot;, [&quot;Half Duplex&quot;, &quot;10Mbps&quot;], &quot;Duplex and speed test&quot;]
]

# add tests processor
nr_with_tests = nr.with_processors(
    [
        TestsProcessor(tests_suite)
    ]
)

# collect output from devices using netmiko_send_commands task plugin
results = nr_with_tests.run(
    task=netmiko_send_commands,
    commands=[
        &quot;show version&quot;,
        &quot;show run | inc logging&quot;,
        &quot;show interfaces&quot;
    ]
)

# prettify results transforming them in a text table using TabulateFormatter
table = TabulateFormatter(results, tabulate=&quot;brief&quot;)

# print results
print(table)
</code></pre><p>Running above code:</p>
<pre><code>python3 test_network_suite_v2.py
</code></pre><p>Should give us this output:</p>
<pre><code>+----+--------+-----------------------------+----------+-----------------------+
|    | host   | name                        | result   | exception             |
+====+========+=============================+==========+=======================+
|  0 | R1     | Software version test       | FAIL     | Pattern not in output |
+----+--------+-----------------------------+----------+-----------------------+
|  1 | R1     | Logging configuration check | PASS     |                       |
+----+--------+-----------------------------+----------+-----------------------+
|  2 | R1     | Duplex and speed test       | PASS     |                       |
+----+--------+-----------------------------+----------+-----------------------+
|  3 | R2     | Software version test       | FAIL     | Pattern not in output |
+----+--------+-----------------------------+----------+-----------------------+
|  4 | R2     | Logging configuration check | PASS     |                       |
+----+--------+-----------------------------+----------+-----------------------+
|  5 | R2     | Duplex and speed test       | PASS     |                       |
+----+--------+-----------------------------+----------+-----------------------+
</code></pre><p><code>TestsProcessor</code> uses tests suite to run the tests - test suite is a list of
dictionaries or a list of lists, where each dictionary or list contains tests details.</p>
<p>List of lists tests suite is more concise but only allows to define these four test parameters:</p>
<ul>
<li>first list item - mandatory, Nornir results task name</li>
<li>second list item - mandatory, test function name</li>
<li>third list item - mandatory, test criteria, pattern</li>
<li>last item - optional, test name</li>
</ul>
<p>Sample list of lists test suite with single test in it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">tests_suite <span style="color:#f92672">=</span> [
    [<span style="color:#e6db74">&#34;show version&#34;</span>, <span style="color:#e6db74">&#34;contains&#34;</span>, <span style="color:#e6db74">&#34;17.3.1&#34;</span>, <span style="color:#e6db74">&#34;Test software version&#34;</span>],
]
</code></pre></div><p>List of dictionaries is more verbose and allows to specify more options, example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">tests_suite <span style="color:#f92672">=</span> [
    {
        <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Test version&#34;</span>,
        <span style="color:#e6db74">&#34;task&#34;</span>: <span style="color:#e6db74">&#34;show version&#34;</span>,
        <span style="color:#e6db74">&#34;test&#34;</span>: <span style="color:#e6db74">&#34;contains&#34;</span>,
        <span style="color:#e6db74">&#34;pattern&#34;</span>: <span style="color:#e6db74">&#34;17.3.1&#34;</span>,
        <span style="color:#e6db74">&#34;err_msg&#34;</span>: <span style="color:#e6db74">&#34;Software version is wrong&#34;</span>
    }
]
</code></pre></div><p>Test dictionary <code>task</code> key indicates name of the Nornir task, results of that task
feed into test function. <code>netmiko_send_commands</code> task plugin conveniently uses command
string as a name for the sub-tasks, making it easy to identify results by command itself.</p>
<p><code>TestsProcessor</code> significantly simplifies running tests for containment or
equality checks using these test functions:</p>
<ul>
<li><code>contains</code> - tests if result contains pattern</li>
<li><code>!contains</code> or <code>ncontains</code> - tests if result does not contain pattern</li>
<li><code>contains_lines</code> - tests if result contains any of the patterns from the list</li>
<li><code>!contains_lines</code> or <code>contains_lines</code> - tests if result does not contain any of the patterns</li>
<li><code>contains_re</code> - tests if result contains regular expression pattern</li>
<li><code>!contains_re</code> or <code>ncontains_re</code> - tests if result does not contains regular expression pattern</li>
<li><code>contains_lines_re</code> - tests if result contains any of the regex patterns from the list</li>
<li><code>!contains_lines_re</code> or <code>ncontains_lines_re</code> - tests if result does not contain any of regex patterns</li>
<li><code>equal</code> - checks that results are equal to provided value</li>
<li><code>!equal</code> or <code>nequal</code> - checks that results are not equal to provided value</li>
</ul>
<p>Containment or equality checks are very similar to how we, Humans, verify output
from devices:</p>
<ol>
<li>Run show command</li>
<li>Check if output contains certain values</li>
<li>Decide if test failed or succeeded</li>
</ol>
<p>Containment test functions do exactly that but in an automated fashion using
output collected from devices by Nornir.</p>
<p>With above test functions we already can test significant set of use cases:</p>
<ul>
<li>device configuration content verification</li>
<li>single show commands output checks</li>
<li>verify ping command results</li>
</ul>
<p>To make up for more &ldquo;production&rdquo; ready example lets use simple trick - move definition of
our tests suite in a <code>tests_suite.yaml</code> file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#66d9ef">name</span>: Software version test
  <span style="color:#66d9ef">task</span>: show version
  <span style="color:#66d9ef">test</span>: contains
  <span style="color:#66d9ef">pattern</span>: <span style="color:#e6db74">&#34;17.3.1&#34;</span>
  <span style="color:#66d9ef">err_msg</span>: Software version is wrong
  
- <span style="color:#66d9ef">name</span>: Logging configuration check
  <span style="color:#66d9ef">task</span>: <span style="color:#e6db74">&#34;show run | inc logging&#34;</span>
  <span style="color:#66d9ef">test</span>: contains
  <span style="color:#66d9ef">pattern</span>: <span style="color:#ae81ff">10.0.0.1</span>
  <span style="color:#66d9ef">err_msg</span>: Logging configuration is wrong
  
- <span style="color:#66d9ef">name</span>: Duplex and speed test
  <span style="color:#66d9ef">task</span>: <span style="color:#e6db74">&#34;show interfaces&#34;</span>
  <span style="color:#66d9ef">test</span>: <span style="color:#e6db74">&#34;!contains_lines&#34;</span>
  <span style="color:#66d9ef">pattern</span>: 
    - Half Duplex
    - 10Mbps
  <span style="color:#66d9ef">err_msg</span>: Logging configuration is wrong
</code></pre></div><p>Update <code>test_network_suite_v2.py</code> code and save it in <code>test_network_suite_v3.py</code> file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> yaml
<span style="color:#f92672">from</span> nornir <span style="color:#f92672">import</span> InitNornir
<span style="color:#f92672">from</span> nornir_salt <span style="color:#f92672">import</span> TestsProcessor, TabulateFormatter, netmiko_send_commands

nr <span style="color:#f92672">=</span> InitNornir(config_file<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;nornir_config.yaml&#34;</span>)

<span style="color:#75715e"># read tests suite</span>
<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;tests_suite.yaml&#34;</span>) <span style="color:#66d9ef">as</span> f:
    tests_suite <span style="color:#f92672">=</span> yaml<span style="color:#f92672">.</span>safe_load(f<span style="color:#f92672">.</span>read())

<span style="color:#75715e"># add tests processor</span>
nr_with_tests <span style="color:#f92672">=</span> nr<span style="color:#f92672">.</span>with_processors(
    [
        TestsProcessor(tests_suite)
    ]
)

<span style="color:#75715e"># collect commands to get from devices accounting </span>
<span style="color:#75715e"># for case when task is a list of commands</span>
commands <span style="color:#f92672">=</span> []
<span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> tests_suite:
    <span style="color:#66d9ef">if</span> isinstance(item[<span style="color:#e6db74">&#34;task&#34;</span>], str):
        commands<span style="color:#f92672">.</span>append(item[<span style="color:#e6db74">&#34;task&#34;</span>])
    <span style="color:#66d9ef">elif</span> isinstance(item[<span style="color:#e6db74">&#34;task&#34;</span>], list):    
        commands<span style="color:#f92672">.</span>extend(item[<span style="color:#e6db74">&#34;task&#34;</span>])
        
<span style="color:#75715e"># collect output from devices using netmiko_send_commands task plugin</span>
results <span style="color:#f92672">=</span> nr_with_tests<span style="color:#f92672">.</span>run(
    task<span style="color:#f92672">=</span>netmiko_send_commands,
    commands<span style="color:#f92672">=</span>commands
)

<span style="color:#75715e"># prettify results transforming them in a text table using TabulateFormatter</span>
table <span style="color:#f92672">=</span> TabulateFormatter(results, tabulate<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;brief&#34;</span>)

<span style="color:#75715e"># print results</span>
<span style="color:#66d9ef">print</span>(table)
</code></pre></div><p>Execute above code:</p>
<pre><code>python3 test_network_suite_v3.py
</code></pre><p>If all good we should see same output as before but this time tests
suite sourced from YAML file.</p>
<p>Abstracting tests suite in a YAML document makes it easy to add or remove tests.</p>
<p>For instance, what if requirements comes in to verify CRC errors counter is below
1000 on all device&rsquo;s interfaces, we can append this test to <code>tests_suite.yaml</code> file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">
- <span style="color:#66d9ef">name</span>: Test interfaces CRC count
  <span style="color:#66d9ef">task</span>: <span style="color:#e6db74">&#34;show interfaces | inc CRC&#34;</span>
  <span style="color:#66d9ef">test</span>: <span style="color:#e6db74">&#34;!contains_re&#34;</span>
  <span style="color:#66d9ef">pattern</span>: <span style="color:#e6db74">&#34;\\d{4,} CRC&#34;</span>
  <span style="color:#66d9ef">err_msg</span>: Interfaces CRC errors above <span style="color:#ae81ff">999</span>
</code></pre></div><p>Regex pattern <code>\\d{4,} CRC</code> will match any 4 digit numbers and above, if such matches
found in output we can be positive that CRC errors are above 999 at least on one of
the interfaces.</p>
<p>Running same <code>python3 test_network_suite_v3.py</code> now gives these results:</p>
<pre><code>+----+--------+-----------------------------+----------+---------------------------+
|    | host   | name                        | result   | exception                 |
+====+========+=============================+==========+===========================+
|  0 | R1     | Software version test       | FAIL     | Software version is wrong |
+----+--------+-----------------------------+----------+---------------------------+
|  1 | R1     | Logging configuration check | PASS     |                           |
+----+--------+-----------------------------+----------+---------------------------+
|  2 | R1     | Duplex and speed test       | PASS     |                           |
+----+--------+-----------------------------+----------+---------------------------+
|  3 | R1     | Test interfaces CRC count   | PASS     |                           |
+----+--------+-----------------------------+----------+---------------------------+
|  4 | R2     | Software version test       | FAIL     | Software version is wrong |
+----+--------+-----------------------------+----------+---------------------------+
|  5 | R2     | Logging configuration check | PASS     |                           |
+----+--------+-----------------------------+----------+---------------------------+
|  6 | R2     | Duplex and speed test       | PASS     |                           |
+----+--------+-----------------------------+----------+---------------------------+
|  7 | R2     | Test interfaces CRC count   | PASS     |                           |
+----+--------+-----------------------------+----------+---------------------------+
</code></pre><p>That is it, now testing your network is as simple as adding more tests in your
<code>tests_suite.yaml</code> file.</p>
<h1 id="nornir-testsprocessor---advance-to-python">Nornir TestsProcessor - advance to Python</h1>
<p>In cases where functionality of containment and pattern matching tests is not enough
we can fall-back on Python Language capabilities. <code>TestsProcessor</code> comes with these
two test functions to help us with exactly that:</p>
<ul>
<li><code>eval</code> test function - uses Python <code>eval</code> and <code>exec</code> built-in function to evaluate
Python expression to produce test results</li>
<li><code>custom</code> test function - uses any custom-defined Python function to perform results
testing</li>
</ul>
<p><strong>Using <code>eval</code> or <code>custom</code> test functions is equivalent to running Python code directly</strong>
<strong>on your system, do not use custom test functions or test suites from untrusted/unverified</strong>
<strong>sources.</strong></p>
<p>By the set of use cases it can address <code>eval</code> probably sits in the middle between
predefined and <code>custom</code> test functions:</p>
<ol>
<li>Predefined test functions only provide pre-baked functionality, but tests easily
defined in a test suite</li>
<li>With <code>eval</code> you already can use Python Language, but limited to a single expression</li>
<li><code>custom</code> test function gives full access to Python Language but requires to write the code</li>
</ol>
<p>From the perspectives of <strong>test complexity</strong> classification we described previously,
predefined and <code>eval</code> test functions help to address low to moderate complexity test
cases while custom test function aims moderate to high complexity scenarios.</p>
<p>This is of course guidelines only, as technically all pre-defined and <code>eval</code> test
functions could be replaced with custom functions.</p>
<p>To demonstrate how to use <code>eval</code> test function lets say new requirements comes in - need to
verify that all interfaces have MTU set to 9200, for that we can append this test
case to <code>tests_suite.yaml</code> file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">
- <span style="color:#66d9ef">name</span>: Test interfaces MTU
  <span style="color:#66d9ef">task</span>: <span style="color:#e6db74">&#34;show interfaces | inc MTU&#34;</span>
  <span style="color:#66d9ef">test</span>: <span style="color:#e6db74">&#34;eval&#34;</span>
  <span style="color:#66d9ef">expr</span>: <span style="color:#e6db74">&#34;all([&#39;9200&#39; in line for line in result.splitlines()])&#34;</span>
  <span style="color:#66d9ef">err_msg</span>: Interface MTU out of range
</code></pre></div><p>Running <code>python3 test_network_suite_v3.py</code> one more time gives these additional results:</p>
<pre><code>+----+--------+-----------------------------+----------+----------------------------+
|    | host   | name                        | result   | exception                  |
+====+========+=============================+==========+============================+
...
+----+--------+-----------------------------+----------+----------------------------+
|  4 | R1     | Test interfaces MTU         | FAIL     | Interface MTU out of range |
+----+--------+-----------------------------+----------+----------------------------+
...
+----+--------+-----------------------------+----------+----------------------------+
|  9 | R2     | Test interfaces MTU         | FAIL     | Interface MTU out of range |
+----+--------+-----------------------------+----------+----------------------------+
</code></pre><p><code>eval</code> test function injects <code>result</code> variable in global space while evaluating Python
expression, that variable contains Nornir task execution results for that particular
task or subtask.</p>
<p>One more interesting use case that <code>eval</code> can help with is processing and testing
structured data. For example, we can parse output from device using <code>textfsm</code>, <code>Genie</code>
or <code>TTP</code> parser so that task result will contain structured data that we can test
using <code>eval</code> test function.</p>
<p>However, while <code>eval</code> is quiet powerful test function it still can fall short in some
scenarios. Moreover, <code>eval</code> expressions could look rather foreign for somebody who does not
familiar with Python. In that case using <code>custom</code> test function could be a better
option.</p>
<p>Let&rsquo;s say new requirement comes in - we need to verify that dot1q tags and IP addresses
configured on device for all sub interfaces that are in UP/UP state.</p>
<p>That type of requirement usually can be addresses following this approach:</p>
<ol>
<li>Collect show commands output from devices</li>
<li>In case if task result is a text - parse it using libraries like <code>TextFSM</code>, <code>Genie</code> or <code>TTP</code></li>
<li>Process structured data further to produce test results</li>
</ol>
<p><code>custom</code> test function requires reference to testing function to feed task results into,
most straightforward way to provide that reference is by using path to a text file with
testing function content - in this case <code>test_sub_interfaces_ip.py</code> file:</p>
<pre><code>from ttp import ttp

ttp_template_intf_cfg = &quot;&quot;&quot;
interface {{ name | contains(&quot;.&quot;) }}
 ip address {{ ip }} {{ mask }}
 encapsulation dot1Q {{ dot1q }}
&quot;&quot;&quot;

ttp_template_intf_state = &quot;&quot;&quot;
&lt;group name=&quot;{{ interface }}&quot;&gt;
{{ interface | contains(&quot;.&quot;) }} is up, line protocol is up
&lt;/group&gt;
&quot;&quot;&quot;

def run(results):
    ret = []
    
    # parse show commands output
    parsed_results = {}
    for result in results:
        if result.name == &quot;show run&quot;:
            parser = ttp(data=result.result, template=ttp_template_intf_cfg)
            parser.parse()
            parsed_results[&quot;cfg&quot;] = parser.result(structure=&quot;flat_list&quot;)
        elif result.name == &quot;show interfaces | inc line protocol is up&quot;:
            parser = ttp(data=result.result, template=ttp_template_intf_state)
            parser.parse()
            parsed_results[&quot;up_interfaces&quot;] = parser.result(structure=&quot;flat_list&quot;)[0]
            
    # parsed_output structure should look like this:
    # {
    #     'cfg': [
    #         {
    #             'ip': '1.2.3.4', 
    #             'mask': '255.255.255.0', 
    #             'name': 'GigabitEthernet5.17', 
    #             'dot1q': '17'
    #         }
    #     ], 
    #     'up_interfaces': {'GigabitEthernet5.17': {}}
    # }    
    
    # process results further
    for interface in parsed_results[&quot;cfg&quot;]:
        # skip interfaces that are not up/up
        if interface[&quot;name&quot;] not in parsed_results[&quot;up_interfaces&quot;]:
            continue
        # if no dot1q tag or IP configured, it is error
        if &quot;ip&quot; not in interface or &quot;dot1q&quot; not in interface:
            ret.append(
                {
                    &quot;result&quot;: &quot;FAILED&quot;,
                    &quot;exception&quot;: &quot;{} is UP/UP but no IP or dot1q configured&quot;.format(
                        interface[&quot;name&quot;]
                    )
                }
            )
            
    return ret
</code></pre><p>Add new test to <code>tests_suite.yaml</code> file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#66d9ef">name</span>: Test sub-interfaces IP
  <span style="color:#66d9ef">task</span>: 
    - <span style="color:#e6db74">&#34;show run&#34;</span>
    - <span style="color:#e6db74">&#34;show interfaces | inc line protocol is up&#34;</span>
  <span style="color:#66d9ef">test</span>: custom
  <span style="color:#66d9ef">function_file</span>: <span style="color:#e6db74">&#34;test_sub_interfaces_ip.py&#34;</span>
</code></pre></div><p>Running our suite one more time - <code>python3 test_network_suite_v3.py</code> - gives these results:</p>
<pre><code>+----+--------+-----------------------------+----------+------------------------------------------------------------+
|    | host   | name                        | result   | exception                                                  |
+====+========+=============================+==========+============================================================+
|  0 | R1     | Software version test       | FAIL     | Software version is wrong                                  |
+----+--------+-----------------------------+----------+------------------------------------------------------------+
|  1 | R1     | Logging configuration check | PASS     |                                                            |
+----+--------+-----------------------------+----------+------------------------------------------------------------+
|  2 | R1     | Duplex and speed test       | PASS     |                                                            |
+----+--------+-----------------------------+----------+------------------------------------------------------------+
|  3 | R1     | Test interfaces CRC count   | PASS     |                                                            |
+----+--------+-----------------------------+----------+------------------------------------------------------------+
|  4 | R1     | Test sub-interfaces IP      | FAILED   | GigabitEthernet5.31 is UP/UP but no IP or dot1q configured |
+----+--------+-----------------------------+----------+------------------------------------------------------------+
|  5 | R1     | Test sub-interfaces IP      | FAILED   | GigabitEthernet2.34 is UP/UP but no IP or dot1q configured |
+----+--------+-----------------------------+----------+------------------------------------------------------------+
|  6 | R1     | Test sub-interfaces IP      | FAILED   | GigabitEthernet4.77 is UP/UP but no IP or dot1q configured |
+----+--------+-----------------------------+----------+------------------------------------------------------------+
|  7 | R2     | Software version test       | FAIL     | Software version is wrong                                  |
+----+--------+-----------------------------+----------+------------------------------------------------------------+
|  8 | R2     | Logging configuration check | PASS     |                                                            |
+----+--------+-----------------------------+----------+------------------------------------------------------------+
|  9 | R2     | Duplex and speed test       | PASS     |                                                            |
+----+--------+-----------------------------+----------+------------------------------------------------------------+
| 10 | R2     | Test interfaces CRC count   | PASS     |                                                            |
+----+--------+-----------------------------+----------+------------------------------------------------------------+
| 11 | R2     | Test sub-interfaces IP      | FAILED   | GigabitEthernet6.18 is UP/UP but no IP or dot1q configured |
+----+--------+-----------------------------+----------+------------------------------------------------------------+
</code></pre><p>Ok, looks like our test suite working and we have some issues to fix.</p>
<p>Custom function file contains single function called <code>run</code> - this is the default name of the
function that <code>TestsProcessor</code> <code>custom</code> test function looks for and executes by default.</p>
<p>Custom test function should accept at least one argument with Nornir task results and
should return single dictionary or a list of dictionaries where each dictionary contains
test results.</p>
<p>In our case test definition <code>task</code> attribute contains a list of commands, because of that
<code>TestsProcessor</code> will feed a list of <code>nornir.core.task.Result</code> objects each containing output
for certain command.</p>
<h1 id="in-conclusion">In conclusion</h1>
<p>Testing is a crucial component for many processes - initial device deployment, new hardware
or software evaluation, ongoing and on failure verifications, pre/post-change tests to name
a few.</p>
<p>Be it a simple containment or pattern check, complex cross output correlation tests or structured
output evaluation - Python, Nornir and now TestsProcessor will be on your side to help
you cope with new requirements and improve the quality of your network.</p>
<blockquote>
<p>“Quality is not an act, it is a habit.”— Aristotle</p>
</blockquote>
<h1 id="reference-notes">Reference notes</h1>
<p>Code examples above reference various files, their content provided below. All <code>.yaml</code> and
<code>.py</code> files should be in same folder.</p>
<p><code>nornir_config.yaml</code> file:</p>
<pre><code>inventory:
    plugin: SimpleInventory
    options:
        host_file: &quot;hosts.yaml&quot;
        
runner:
    plugin: threaded
    options:
        num_workers: 5
</code></pre><p><code>hosts.yaml</code> file:</p>
<pre><code>R1:
  hostname: 192.168.1.10
  platform: ios
  password: nornir
  username: nornir
      
R2:
  hostname: 192.168.1.11
  platform: ios
  password: nornir
  username: nornir
</code></pre><p>Software versions Author used to run the code:</p>
<ul>
<li>Python 3.6</li>
<li>Nornir 3.1.1 - <code>pip install nornir</code></li>
<li>Nornir-netmiko 0.1.1 - <code>pip install nornir-netmiko</code></li>
<li>Netmiko 3.4.0 - <code>pip install netmiko</code></li>
<li>Nornir-salt 0.4.0 - <code>pip install nornir-salt</code></li>
<li>Tabulate 0.8.3 - <code>pip install tabulate</code></li>
<li>PyYAML 5.3.1 - <code>pip install pyyaml</code></li>
<li>Pytest 6.2.4 - <code>pip install pytest</code></li>
<li>TTP 0.7.2 - <code>pip install ttp</code></li>
</ul>

            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="/tags/nornir">nornir</a></span><span class="tag"><a href="/tags/guest">guest</a></span><span class="tag"><a href="/tags/testing">testing</a></span><span class="tag"><a href="/tags/network-testing">network testing</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>3231 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2021-08-06 00:00 &#43;0000</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h">Read other posts</span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    

                    
                        <span class="button next">
                            <a href="/2021/07/16/saltstack-nornir-proxy-minion-introduction/">
                                <span class="button__text">SALTSTACK Nornir Proxy Minion introduction</span>
                                <span class="button__icon">→</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2023
							
							Nornir
						</span>
            <span> <a href="/posts/index.xml" target="_blank" title="rss"><svg xmlns="https://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
                    &nbsp; <a href="https://twitter.com/dbarrosop" target="_blank" rel="noopener" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a> &nbsp;&nbsp; <a href="https://github.com/dbarrosop" target="_blank" rel="noopener" title="Github"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a> &nbsp;&nbsp; <a href="https://linkedin.com/dbarrosop" target="_blank" rel="noopener" title="Linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a> &nbsp;&nbsp; <a href="mailto:dbarrosop@dravetech.com" target="_blank" rel="noopener" title="Email"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a> &nbsp;
                </span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span><a href="/about/">About us</a></span>
            <span>Powered by <a href="https://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.dc716e9092c9820b77f96da294d0120aeeb189b5bcea9752309ebea27fd53bbe6b13cffb2aca8ecf32525647ceb7001f76091de4199ac5a3caa432c070247f5b.js" integrity="sha512-3HFukJLJggt3&#43;W2ilNASCu6xibW86pdSMJ6&#43;on/VO75rE8/7KsqOzzJSVkfOtwAfdgkd5BmaxaPKpDLAcCR/Ww=="></script>



    </body>
</html>
