<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="This is a guest post by John McGovern (IPvZero), for more content like this and other interesting stuff you can visit the following youtube channel, github account, and twitter feed.
 This tutorial aims to provide a simple use-case for combining Nornir and pyATS together in order to profile your current network configurations and implement desired state - as specified in host variable definition files.
The workflow we will follow in this tutorial will be first to:" />
<meta name="keywords" content="nornir automation networking programming python golang, nornir, pyATS, guest" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="/2020/05/13/tutorial-combining-nornir-with-pyats/" />


    <title>
        
            Tutorial: Combining Nornir with pyATS :: nornir.tech  — News and information about nornir&#39;s projects
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.min.84ed5579024525d4b50458514d1a43e40dd5272df45c7cd6da85b225af457154.css">


    
        <link rel="stylesheet" type="text/css" href="/css/callout.css">
    

    
        <link rel="stylesheet" type="text/css" href="/css/menu.css">
    



<meta itemprop="name" content="Tutorial: Combining Nornir with pyATS">
<meta itemprop="description" content="This is a guest post by John McGovern (IPvZero), for more content like this and other interesting stuff you can visit the following youtube channel, github account, and twitter feed.
 This tutorial aims to provide a simple use-case for combining Nornir and pyATS together in order to profile your current network configurations and implement desired state - as specified in host variable definition files.
The workflow we will follow in this tutorial will be first to:">
<meta itemprop="datePublished" content="2020-05-13T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-05-13T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="2423">
<meta itemprop="image" content="/"/>



<meta itemprop="keywords" content="nornir,pyATS,guest," /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/"/>

<meta name="twitter:title" content="Tutorial: Combining Nornir with pyATS"/>
<meta name="twitter:description" content="This is a guest post by John McGovern (IPvZero), for more content like this and other interesting stuff you can visit the following youtube channel, github account, and twitter feed.
 This tutorial aims to provide a simple use-case for combining Nornir and pyATS together in order to profile your current network configurations and implement desired state - as specified in host variable definition files.
The workflow we will follow in this tutorial will be first to:"/>





    <meta property="article:published_time" content="2020-05-13 00:00:00 &#43;0000 UTC" />








    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">nornir.tech</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner">
          <li>
            <div class="dropdown">
              <button class="dropbtn">projects
                <i class="fa fa-caret-down"></i>
              </button>
              <div class="dropdown-content">
                
                <a href="/nornir/">nornir</a>
                
                <a href="/gornir/">gornir</a>
                
                <a href="/tags/external-projects/">third party</a>
                
              </div>
            </div>
          </li>
          
            <li><a href="/posts/">news</a></li>
          
            <li><a href="/support/">support</a></li>
          
            <li><a href="/sponsors/">sponsors</a></li>
          
            <li><a href="/tags/">tags</a></li>
          
    </ul>

</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>12 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title">
                <a href="/2020/05/13/tutorial-combining-nornir-with-pyats/">Tutorial: Combining Nornir with pyATS</a>
            </h1>

            

            <div class="post-content">
                <p><em>This is a guest post by John McGovern (IPvZero), for more content like this and other interesting stuff you can visit the following <a href="https://youtube.com/c/IPvZero">youtube channel</a>, <a href="https://github.com/IPvZero">github account</a>, and <a href="https://twitter.com/IPvZero">twitter feed</a>.</em></p>
<hr>
<p>This tutorial aims to provide a simple use-case for combining <a href="https://github.com/nornir-automation/nornir/">Nornir</a> and <a href="https://pubhub.devnetcloud.com/media/pyats/docs/getting_started/index.html">pyATS</a> together in order to profile your current network configurations and implement desired state - as specified in host variable definition files.</p>
<p>The workflow we will follow in this tutorial will be first to:</p>
<ul>
<li>Deploy OSPF desired state using Nornir</li>
<li>Immediately deploying pyATS to capture a golden image profile of this &ldquo;desired state&rdquo;</li>
</ul>
<p>After we have conducted the initial steps we will then deploy a python script (<code>Pynir.py</code>) that will:</p>
<ul>
<li>Invoke pyATS to profile the current OSPF configuration and compare it to the golden image previously captured.</li>
<li>If pyATS detects a difference – the terminal will prompt an alert signalling that OSPF in currently out of sync with desired state</li>
<li>The script will then give the user the option to rollback to desired state</li>
<li>Should the user answer <strong>No</strong> – the script ends and all current OSPF settings and Diff artefacts are left and are able to be inspected</li>
<li>Should the user answer <strong>Yes</strong> – the script invokes Nornir to first erase all OSPF configurations currently in the network, before reimplementing desired state by pulling information from host variable definition files and leveraging jinja2 templating.</li>
<li>Lastly, if the script detects that the current OSPF profile is identical to the OSPF desired state, it will generate a message informing us that all current configurations are matching our desired state.</li>
</ul>
<p>To begin, let&rsquo;s first look at the directory structure and setup:</p>
<pre><code>ipvzero@MSI:~/Nornir-Blog$ tree
.
├── Pynir.py
├── capture-golden
├── config.yaml
├── defaults.yaml
├── groups.yaml
├── host_vars
│   ├── R1.yaml
│   ├── R2.yaml
│   ├── R3.yaml
│   ├── R4.yaml
│   ├── R5.yaml
│   ├── R6.yaml
│   ├── R7.yaml
│   └── R8.yaml
├── hosts.yaml
├── nornir-ospf.py
├── nornir.log
├── templates
│   └── ospf.j2
└── testbed.yaml

2 directories, 18 files
</code></pre><p>As you can see we can our basic Nornir yaml files:</p>
<ul>
<li><code>hosts.yaml</code></li>
<li><code>groups.yaml</code></li>
<li><code>defaults.yaml</code></li>
</ul>
<p>Notice that there is also a <code>testbed.yaml</code> file to allow pyATS to connect into and profile the network. Next, you&rsquo;ll notice we also have two directories. The first one called <code>host_vars</code> which will house our OSPF host variables (note: you can use the <code>hosts.yaml</code> file instead, but I have chosen to create a separate directory to perform this task). The second is called <code>templates</code> which will house our OSPF Jinja2 template.</p>
<p>Importantly, you&rsquo;ll notice a <code>capture-golden</code> file. This is a very simple bash script used to capture our &ldquo;golden&rdquo; snapshot of our desired OSPF state. It simply executes a pyATS command. You can type this command by hand should you wish, but since the output directory has to remain the same since it will be referenced by the <code>Pynir.py</code> script – for consistency, I have elected to execute it from a bash script to prevent me mistyping the output destination. Let&rsquo;s look inside to see what&rsquo;s going on:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>pyats learn ospf --testbed-file testbed.yaml --output desired-ospf
</code></pre></div><p>As you can see the bash script simply tells pyATS to learn the network&rsquo;s OSPF configurations and save the output into a directory called <code>desired-ospf</code>. This directory will act as our reference point.</p>
<p>Let&rsquo;s take a look inside the <code>host_vars</code> directory and see what our host variable definition files look like. For brevity, let&rsquo;s just look at <code>R1.yaml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
<span style="color:#66d9ef">OSPF</span>:
    <span style="color:#66d9ef">process</span>: <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">id </span>: <span style="color:#ae81ff">1.1.1.1</span>
    <span style="color:#66d9ef">networks</span>:
      - <span style="color:#66d9ef">net</span>: <span style="color:#ae81ff">192.168.1.0</span>
        <span style="color:#66d9ef">wildcard</span>: <span style="color:#ae81ff">0.0.0.255</span>
        <span style="color:#66d9ef">area</span>: <span style="color:#ae81ff">0</span>
      - <span style="color:#66d9ef">net</span>: <span style="color:#ae81ff">192.168.10.0</span>
        <span style="color:#66d9ef">wildcard</span>: <span style="color:#ae81ff">0.0.0.255</span>
        <span style="color:#66d9ef">area</span>: <span style="color:#ae81ff">0</span>
</code></pre></div><p>We have a very basic OSPF setup which lists the process ID number, the RID, and the network statement configs for the router. R2 through to R8 have very similar configurations. As this is simply a demo, I have created easily identifiable variations between files. For example, R5 uses OSPF process ID of 5, with a RID of 5.5.5.5 and the networks it advertises are &ldquo;192.168.5.0&rdquo; and &ldquo;192.168.50.0&rdquo;. These files represent our desired state. In other words, this is what our network &ldquo;should look like&rdquo;.</p>
<p>Next, let&rsquo;s look inside the templates directory and open our <code>ospf.j2</code> file:</p>
<pre><code class="language-jinja2" data-lang="jinja2">router ospf {{ host.OSPF.process }}
  router-id {{ host.OSPF.id }}
  {% for n in host.OSPF.networks %}
  network {{ n.net }} {{ n.wildcard }} area {{ n.area }}
  {% endfor %}
</code></pre><p>This template will simply reference the Keys specificed in our host_var yaml files and populate the template with their corresponding Values to build our desired OSPF configuration.</p>
<p>You will notice we have a <code>nornir-ospf.py</code> script. This is the script we will use to first initially push our desired state onto the routers. This script simply pulls desired state from our <code>host_vars</code> and pushes them through our Jinja2 template onto the network. In other words, it does not remove old stale configs (like <code>Pynir.py</code> will) so the assumption here is that we are working with a blank slate on the devices. Let&rsquo;s look inside the script:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> nornir <span style="color:#f92672">import</span> InitNornir
<span style="color:#f92672">from</span> nornir.plugins.tasks.data <span style="color:#f92672">import</span> load_yaml
<span style="color:#f92672">from</span> nornir.plugins.tasks.text <span style="color:#f92672">import</span> template_file
<span style="color:#f92672">from</span> nornir.plugins.functions.text <span style="color:#f92672">import</span> print_result
<span style="color:#f92672">from</span> nornir.plugins.tasks.networking <span style="color:#f92672">import</span> netmiko_send_config

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_ospf</span>(task):
    data <span style="color:#f92672">=</span> task<span style="color:#f92672">.</span>run(task<span style="color:#f92672">=</span>load_yaml,file<span style="color:#f92672">=</span>f<span style="color:#e6db74">&#39;./host_vars/{task.host}.yaml&#39;</span>)
    task<span style="color:#f92672">.</span>host[<span style="color:#e6db74">&#34;OSPF&#34;</span>] <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>result[<span style="color:#e6db74">&#34;OSPF&#34;</span>]
    r <span style="color:#f92672">=</span> task<span style="color:#f92672">.</span>run(task<span style="color:#f92672">=</span>template_file, template<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ospf.j2&#34;</span>, path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./templates&#34;</span>)
    task<span style="color:#f92672">.</span>host[<span style="color:#e6db74">&#34;config&#34;</span>] <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>result
    output <span style="color:#f92672">=</span> task<span style="color:#f92672">.</span>host[<span style="color:#e6db74">&#34;config&#34;</span>]
    send <span style="color:#f92672">=</span> output<span style="color:#f92672">.</span>splitlines()
    task<span style="color:#f92672">.</span>run(task<span style="color:#f92672">=</span>netmiko_send_config, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;IPvZero Commands&#34;</span>, config_commands<span style="color:#f92672">=</span>send)

nr <span style="color:#f92672">=</span> InitNornir()
results <span style="color:#f92672">=</span> nr<span style="color:#f92672">.</span>run(load_ospf)
print_result(results)
</code></pre></div><p>This is a fairly typical script which will pull information from the desired state specified in our <code>host_vars</code> yaml files, save the information and use those values to build our configurations based on the syntax specified in our Jinja2 template. Nornir then invokes Netmiko to push those configurations out to all of our respective devices in the network. Now that we understand what&rsquo;s going on, let&rsquo;s execute that script and push our desired state onto our otherwise blank network:</p>
<p><img src="https://github.com/IPvZero/Nornir-Blog/blob/master/images/6.png?raw=true" alt="alt text"></p>
<p>With our desired state now present on the network, let&rsquo;s immediately use pyATS to build a detailed profile of that configuration and grab our &ldquo;golden&rdquo; snapshot. Let&rsquo;s execute the <code>capture-golden</code> script:</p>
<p><img src="https://github.com/IPvZero/Nornir-Blog/blob/master/images/7.png?raw=true" alt="alt text"></p>
<p>pyATS has successfully profiled our desired state and you will notice the addition of a new directory called <code>desired-ospf</code> which houses of all of our detailed OSPF information for each device.
Now that we have pushed our desired state and successfully created a snapshot for future comparison, let&rsquo;s look at the main script which we will use for our OSPF management going forward, <code>Pynir.py</code>. The script is relatively long so let&rsquo;s break it down into sections. First we begin with our imports - and I have also included a Pyfiglet banner for purely aesthetic purposes (who doesn&rsquo;t like to make their scripts pretty, right?).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> subprocess
<span style="color:#f92672">import</span> colorama
<span style="color:#f92672">from</span> colorama <span style="color:#f92672">import</span> Fore, Style
<span style="color:#f92672">from</span> nornir <span style="color:#f92672">import</span> InitNornir
<span style="color:#f92672">from</span> nornir.plugins.tasks.networking <span style="color:#f92672">import</span> netmiko_send_command
<span style="color:#f92672">from</span> nornir.plugins.functions.text <span style="color:#f92672">import</span> print_result, print_title
<span style="color:#f92672">from</span> nornir.plugins.tasks.networking <span style="color:#f92672">import</span> netmiko_send_config
<span style="color:#f92672">from</span> nornir.plugins.tasks.data <span style="color:#f92672">import</span> load_yaml
<span style="color:#f92672">from</span> nornir.plugins.tasks.text <span style="color:#f92672">import</span> template_file
<span style="color:#f92672">from</span> pyfiglet <span style="color:#f92672">import</span> Figlet

nr <span style="color:#f92672">=</span> InitNornir(config_file<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;config.yaml&#34;</span>)
clear_command <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;clear&#34;</span>
os<span style="color:#f92672">.</span>system(clear_command)
custom_fig <span style="color:#f92672">=</span> Figlet(font<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;isometric3&#39;</span>)
<span style="color:#66d9ef">print</span>(custom_fig<span style="color:#f92672">.</span>renderText(<span style="color:#e6db74">&#39;pyNIR&#39;</span>))
</code></pre></div><p>Next, we create a custom function called <code>clean_ospf</code>. The first challenge of the script was to find a way to strip away all OSPF configurations, should that be required. The problem with automating over legacy devices with no API capabilities, however, is that we are heavily reliant on screen-scraping – an inelegant and unfortunately necessary solution. To do so, I made the decision to use Nornir to execute a <code>show run | s ospf</code> on all devices, saved the resulting output, and began screen-scraping to identify digits in the text. The aim here was to identify any OSPF process IDs which could then be extracted and used to negate the process by executing a <code>no router opsf</code>; followed by the relevant process ID. The challenge here is that the show command output would also include area ID information – and OSPFs most common area configuration is for area 0. Of course <code>router ospf 0</code> is not a legal command, so in order to avoid this I included a conditional statement that would skip over and <code>continue</code> past any number zeros in the output. The second challenge would be avoiding needless repetition. Should OSPF be configured via the interfaces, the resulting show output could, for example, have multiple: <code>ip ospf 1 area 0</code>
<code>ip ospf 1 area 0</code>.
Parsing out this information could lead to the script executing multiple <code>no router ospf 1</code>; commands which is, of course, unnecessary. To avoid this, I elected to push all output into a python list, and from there remove all duplicates. There is still, however, an inefficiency given that the show output could, for example, show a multi-area OSPF configuration all within the same process. This could result in a script seeing an <code>ip ospf 1 area 5</code> configuration and attempting to execute a superfluous <code>no router ospf 5</code>. However, given that the script has protections against repetitive execution, and that routers will have limited areas configured per device (maybe 3 different areas at most per device, if at all), I made the decision that this was an acceptable inefficiency. Like I say, there is nothing elegant about screen-scraping and sometimes a 90% solution is better than no solution:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">clean_ospf</span>(task):
    r <span style="color:#f92672">=</span> task<span style="color:#f92672">.</span>run(task<span style="color:#f92672">=</span>netmiko_send_command, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Identifying Current OSPF&#34;</span>, command_string <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;show run | s ospf&#34;</span>)
    output <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>result
    my_list <span style="color:#f92672">=</span> []
    num <span style="color:#f92672">=</span> [int(s) <span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> output<span style="color:#f92672">.</span>split() <span style="color:#66d9ef">if</span> s<span style="color:#f92672">.</span>isdigit()]
    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> num:
        <span style="color:#66d9ef">if</span> x <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
            <span style="color:#66d9ef">continue</span>
        my_list<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#34;no router ospf &#34;</span> <span style="color:#f92672">+</span> str(x))
    my_list <span style="color:#f92672">=</span> list(dict<span style="color:#f92672">.</span>fromkeys(my_list))
    <span style="color:#66d9ef">for</span> commands <span style="color:#f92672">in</span> my_list:
        task<span style="color:#f92672">.</span>run(task<span style="color:#f92672">=</span>netmiko_send_config, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Removing Current OSPF&#34;</span>, config_commands<span style="color:#f92672">=</span>commands)

    desired_ospf(task)
</code></pre></div><p>Now we have the ability to remove all current OSPF configuration, we create a custom function called <code>desired_ospf</code>. This is almost identical to the earlier script and simply builds our configuration from <code>host_vars</code> definition files and pushes them through our jinja2 OSPF template and out to the devices:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">desired_ospf</span>(task):
    data <span style="color:#f92672">=</span> task<span style="color:#f92672">.</span>run(task<span style="color:#f92672">=</span>load_yaml, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Pulling from Definition Files&#34;</span>, file<span style="color:#f92672">=</span>f<span style="color:#e6db74">&#39;./host_vars/{task.host}.yaml&#39;</span>)
    task<span style="color:#f92672">.</span>host[<span style="color:#e6db74">&#34;OSPF&#34;</span>] <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>result[<span style="color:#e6db74">&#34;OSPF&#34;</span>]
    r <span style="color:#f92672">=</span> task<span style="color:#f92672">.</span>run(task<span style="color:#f92672">=</span>template_file, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Building Desired State&#34;</span>, template<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ospf.j2&#34;</span>, path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./templates&#34;</span>)
    task<span style="color:#f92672">.</span>host[<span style="color:#e6db74">&#34;config&#34;</span>] <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>result
    output <span style="color:#f92672">=</span> task<span style="color:#f92672">.</span>host[<span style="color:#e6db74">&#34;config&#34;</span>]
    send <span style="color:#f92672">=</span> output<span style="color:#f92672">.</span>splitlines()
    task<span style="color:#f92672">.</span>run(task<span style="color:#f92672">=</span>netmiko_send_config, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Implementing OSPF Desired State&#34;</span>, config_commands<span style="color:#f92672">=</span>send)
</code></pre></div><p>The next part of the script is effectively what executes first and precedes our two custom functions (with will only execute upon certain conditions). Let&rsquo;s look at it. First we use the OS and Subprocess python modules to first execute the shell command <code>pyats learn ospf --testbed-file testbed.yaml --output ospf-current</code> to relearn the current state of the network&rsquo;s OSPF configs, and then run a diff between the current configs, and our previously saved golden config – <code>pyats diff desired-ospf/ ospf-current –output ospfdiff</code>. We then read the output and search for the string <code>Diff can be found</code>. If a difference is found, we are alerted to the discrepancy and offered the choice to rollback to our desired state.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">current <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;pyats learn ospf --testbed-file testbed.yaml --output ospf-current&#34;</span>
os<span style="color:#f92672">.</span>system(current)
command <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>run([<span style="color:#e6db74">&#34;pyats&#34;</span>, <span style="color:#e6db74">&#34;diff&#34;</span>, <span style="color:#e6db74">&#34;desired-ospf/&#34;</span>, <span style="color:#e6db74">&#34;ospf-current&#34;</span>, <span style="color:#e6db74">&#34;--output&#34;</span>, <span style="color:#e6db74">&#34;ospfdiff&#34;</span>], stdout<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>PIPE)
stringer <span style="color:#f92672">=</span> str(command)
<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;Diff can be found&#34;</span> <span style="color:#f92672">in</span> stringer:
    os<span style="color:#f92672">.</span>system(clear_command)
    <span style="color:#66d9ef">print</span>(Fore<span style="color:#f92672">.</span>CYAN <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;#&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">70</span>)
    <span style="color:#66d9ef">print</span>(Fore<span style="color:#f92672">.</span>RED <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;ALERT: &#34;</span> <span style="color:#f92672">+</span> Style<span style="color:#f92672">.</span>RESET_ALL <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;CURRENT OSPF CONFIGURATIONS ARE NOT IN SYNC WITH DESIRED STATE!&#34;</span>)
    <span style="color:#66d9ef">print</span>(Fore<span style="color:#f92672">.</span>CYAN <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;#&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">70</span>)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
    answer <span style="color:#f92672">=</span> input(Fore<span style="color:#f92672">.</span>YELLOW <span style="color:#f92672">+</span>
            <span style="color:#e6db74">&#34;Would you like to reverse the current OSPF configuration back to its desired state? &#34;</span> <span style="color:#f92672">+</span> Style<span style="color:#f92672">.</span>RESET_ALL <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&lt;y/n&gt;: &#34;</span>
)
</code></pre></div><p>Should we answer &ldquo;y&rdquo; and affirm our decision to rollback, the script will first remove all current ospf and diff artefacts before calling our <code>clean_ospf</code> custom function, which, in turn, calls our <code>desired-ospf</code> function and prints the output.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#66d9ef">if</span> answer <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;y&#34;</span>:
        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>() <span style="color:#f92672">-&gt;</span> None:
            clean_up <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;rm -r ospfdiff ospf-current&#34;</span>
            os<span style="color:#f92672">.</span>system(clean_up)
            os<span style="color:#f92672">.</span>system(clear_command)
            nr <span style="color:#f92672">=</span> InitNornir(config_file<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;config.yaml&#34;</span>)
            output <span style="color:#f92672">=</span> nr<span style="color:#f92672">.</span>run(task<span style="color:#f92672">=</span>clean_ospf)
            print_title(<span style="color:#e6db74">&#34;REVERSING OSPF CONFIGURATION BACK INTO DESIRED STATE&#34;</span>)
            print_result(output)

        <span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
                main()
</code></pre></div><p>Should we choose <strong>not</strong> to rollback, however, and instead want to inspect those changes in detail - by selecting &ldquo;n&rdquo; the script simply terminates and leaves all artefacts for our inspection.</p>
<p>Lastly, should the script detect no changes between the current state of our OSPF network and the configurations in our golden capture – the script simply ends and informs us that all OSPF configurations are matching desired state:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">else</span>:
    clean_up <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;rm -r ospfdiff ospf-current&#34;</span>
    os<span style="color:#f92672">.</span>system(clean_up)
    os<span style="color:#f92672">.</span>system(clear_command)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;*&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">75</span>)
    <span style="color:#66d9ef">print</span>(Fore<span style="color:#f92672">.</span>GREEN <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;Good news! OSPF configurations are matching desired state!&#34;</span> <span style="color:#f92672">+</span> Style<span style="color:#f92672">.</span>RESET_ALL)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;*&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">75</span>)

</code></pre></div><h2 id="demo---lets-break-the-network">Demo - Let&rsquo;s Break The Network!</h2>
<p>Now that we understand the logic of the script, let&rsquo;s perform a demo and see the workflow in action. Now remember, we have already deployed our initial desired state and captured that snapshot using both the <code>nornir-ospf.py</code> and <code>capture-golden</code> scripts. Let&rsquo;s first &ldquo;break&rdquo; the network by adding some unwanted OSPF configurations on R8:</p>
<p><img src="https://github.com/IPvZero/Nornir-Blog/blob/master/images/14.png?raw=true" alt="alt text"></p>
<p>Now the current state of our OSPF network does not match the configuration specified in our desired state. Let&rsquo;s run the <code>Pynir.py</code> script and see if it detects the change. <code>Pynir.py</code> first starts learning the current OSPF configurations:</p>
<p><img src="https://github.com/IPvZero/Nornir-Blog/blob/master/images/15.png?raw=true" alt="alt text"></p>
<p>The change is detected and we are both notified and given the option to rollback. This time, we first want to inspect the changes, so let&rsquo;s answer &ldquo;n&rdquo; for No:</p>
<p><img src="https://github.com/IPvZero/Nornir-Blog/blob/master/images/16.png?raw=true" alt="alt text"></p>
<p>The script terminates and leaves the relevant artefacts which we are free to inspect (notice the new directories <code>ospf-current</code> and <code>ospfdiff</code>):</p>
<p><img src="https://github.com/IPvZero/Nornir-Blog/blob/master/images/17.png?raw=true" alt="alt text"></p>
<p>We can now freely examine these changes and decide if we want to erase them by performing a rollback, or leave them and updating our OSPF definitions:</p>
<p><img src="https://github.com/IPvZero/Nornir-Blog/blob/master/images/18.png?raw=true" alt="alt text"></p>
<p>Upon examination it is clear now that these configuration are certainly not meant to be present in the network. We then rerun Pynir, this time choosing &ldquo;y&rdquo; to rollback to our desired state:</p>
<p><img src="https://github.com/IPvZero/Nornir-Blog/blob/master/images/19.png?raw=true" alt="alt text"></p>
<p>This selection triggers Nornir to execute our custom functions that remove all current OSPF configs and artefacts before redeploying OSPF as specified in our <code>host_vars</code> definition files.</p>
<p>First the OSPF configurations are identified by the show output, and then negated:</p>
<p><img src="https://github.com/IPvZero/Nornir-Blog/blob/master/images/20.png?raw=true" alt="alt text"></p>
<p>Pynir then pulls out desired state from our host varables, builds our configuration using the Jinja2 template, and pushes out the config: <img src="https://github.com/IPvZero/Nornir-Blog/blob/master/images/21.png?raw=true" alt="alt text"></p>
<p>For our final validation, let&rsquo;s rerun the script and ensure that we are now in compliance with our desired state:</p>
<p><img src="https://github.com/IPvZero/Nornir-Blog/blob/master/images/22.png?raw=true" alt="alt text"></p>
<p>Excellent! Everything is back to the way it should be.</p>
<p>As you can see, combining Nornir with pyATS can allow us to easily monitor and rollback our network to ensure we are compliant with our desired state of the network. As demonstrated, the largest challenge was finding a workaround to remove all undesired OSPF configurations. With modern devices with APIs, with options for candidate configurations, etc, this problem vanishes. Unfortunately, however, we still need to deal with older devices that were not built with automation in mind, and we have to create inventive and sometimes inefficient workarounds to solve a particular problem. This script is an attempt at doing that.</p>
<p>You can download the script and all subsequent configurations at:
<a href="https://github.com/IPvZero/pynir">https://github.com/IPvZero/pynir</a></p>

            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="/tags/nornir">nornir</a></span><span class="tag"><a href="/tags/pyats">pyATS</a></span><span class="tag"><a href="/tags/guest">guest</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>2423 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2020-05-13 00:00 &#43;0000</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h">Read other posts</span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    

                    
                        <span class="button next">
                            <a href="/2020/05/01/how-many-threads-are-enough-threads/">
                                <span class="button__text">how many threads are enough threads?</span>
                                <span class="button__icon">→</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2020
							
							Nornir
						</span>
            <span> <a href="/posts/index.xml" target="_blank" title="rss"><svg xmlns="https://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
                    &nbsp; <a href="https://twitter.com/dbarrosop" target="_blank" rel="noopener" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a> &nbsp;&nbsp; <a href="https://github.com/dbarrosop" target="_blank" rel="noopener" title="Github"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a> &nbsp;&nbsp; <a href="https://linkedin.com/dbarrosop" target="_blank" rel="noopener" title="Linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a> &nbsp;&nbsp; <a href="mailto:dbarrosop@dravetech.com" target="_blank" rel="noopener" title="Email"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a> &nbsp;
                </span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span><a href="/about/">About us</a></span>
            <span>Powered by <a href="https://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.2d5469329143160ae2456a69c3c76dc2d0a3b212b46afe291a51bd68650ed6f8697e001dab54f1c272c77ce08092a8c55e5bb4314e0ee334aab4b927ec896638.js" integrity="sha512-LVRpMpFDFgriRWppw8dtwtCjshK0av4pGlG9aGUO1vhpfgAdq1TxwnLHfOCAkqjFXlu0MU4O4zSqtLkn7IlmOA=="></script>



    </body>
</html>
